#!/bin/sh
# postinst script for qmon-popeye-conf
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)
      ENV_TYPE=development
      if [ -f /etc/yandex/environment.type ]; then
          ENV_TYPE=`cat /etc/yandex/environment.type`
          echo "environment type is $ENV_TYPE"
      else
          echo 'yandex environment is not set, defaulting to development'
          ENV_TYPE=development
      fi
    
      for APP_NAME in 'qmon-popeye' 'qmon-popeye-slicer' 'qmon-popeye-pump' 'qmon-popeye-query' ; do
        QMON_CONF_DIR=/etc/yandex/$APP_NAME/$ENV_TYPE
        if [ ! -d $QMON_CONF_DIR ] ; then
          echo "no configuration for $APP_NAME $ENV_TYPE"
          exit 1
        fi
        ln -sfn $QMON_CONF_DIR /etc/yandex/$APP_NAME/conf
        chmod -R 655 $QMON_CONF_DIR 
      done
      myzk=`cat /etc/yandex/qmon-popeye/conf/kafka-zoo`
      popeyeDir=`ls /usr/share/ | grep -E 'qmon-popeye-(slicer|pump|query)' | head -n 1`
      if [ -n $popeyeDir ] ; then
        cat /etc/yandex/qmon-popeye/conf/kafka-topics | while read topic partitions replication
            do
                echo 'java -cp "/usr/share/$popeyeDir/lib*" kafka.admin.TopicCommand --zookeeper $myzk --create --partitions $partitions --replication-factor $replication --topic $topic'
                java -cp "/usr/share/$popeyeDir/lib/*" kafka.admin.TopicCommand --zookeeper $myzk --create --partitions $partitions --replication-factor $replication --topic $topic
            done
      else
        echo "cannot create kafka topics, reason: cannot find popeye libraries at /usr/share/qmon-popeye-(slicer|pump|query)/lib"
        exit 1
      fi
      break
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
