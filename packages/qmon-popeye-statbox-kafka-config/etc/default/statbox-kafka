JMX_PORT=9999
KAFKA_JMX_OPTS="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false  -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.port=$JMX_PORT "
KAFKA_OPTS="-Xmx24384M -server  -Dlog4j.configuration=file:/etc/yandex/statbox-kafka/kafka-log4j.properties $KAFKA_JMX_OPTS"
KAFKA_CONF="/etc/yandex/statbox-kafka/server.properties"

source /etc/default/detect-broker-id
base=/local/

if [ -f /etc/yandex/environment.type ]
then
	env=`cat /etc/yandex/environment.type`
	if [ $env == "testing" ]
	then
		base=/srv/
		KAFKA_OPTS="-Xmx4000M -server  -Dlog4j.configuration=file:/etc/yandex/statbox-kafka/kafka-log4j.properties $KAFKA_JMX_OPTS"
	fi
fi

# /usr/bin/logbroker-mytopics.sh > /dev/null || (echo "has not isr replicas" && exit 1)
# TODO: check other brokers running

python /usr/share/statbox-logbroker/gen-config.py $base /etc/yandex/statbox-kafka/server-$dc.properties $broker_id $dc > $KAFKA_CONF || exit 1

cat /etc/yandex/statbox-kafka/dc-map | while read dcFromZkConfig myzk
do
	if [ r"$dc" == r"$dcFromZkConfig" ]
	then
	    zkWithoutChroot=`python -c "print \"$myzk\".split(\"/\")[0]"`    
	    zookeeper-client -server $zkWithoutChroot create /kafka kafka_root
	    break
	fi
done
